{% extends 'base.html' %}

{% block title %}Buy {{ plant.name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="flex items-center mb-6">
    <a href="{% url 'market_home' %}" class="flex items-center text-green-600 hover:text-green-700 transition duration-300">
      <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
      Back to Market
    </a>
  </div>

  <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <div class="md:flex">
        <!-- Plant Image -->
        <div class="md:w-1/2">
          <img src="{{ plant.image.url }}" alt="{{ plant.name }}" class="w-full h-full object-cover">
        </div>

        <!-- Plant Details -->
        <div class="md:w-1/2 p-6">
          <div class="flex justify-between items-start">
            <h1 class="text-2xl font-bold text-gray-800">{{ plant.name }}</h1>
            <span class="bg-green-100 text-green-800 text-lg font-medium px-3 py-1 rounded">₹{{ plant.price }}</span>
          </div>

          <div class="mt-4">
            <p class="text-gray-600">{{ plant.description }}</p>
          </div>

          <div class="mt-4 pb-4 border-b border-gray-200">
            <p class="text-gray-600">
              <span class="font-medium">Seller:</span> {{ plant.seller.username }}
            </p>
            <p class="text-gray-600">
              <span class="font-medium">Listed on:</span> {{ plant.date_listed|date:"F j, Y" }}
            </p>
            <p class="text-gray-600 mt-2">
              <span class="font-medium">Availability:</span>
              <span class="{% if plant.quantity_available < 5 %}text-orange-500 font-medium{% endif %}">
                {{ plant.quantity_available }} unit{% if plant.quantity_available != 1 %}s{% endif %} available
              </span>
            </p>
          </div>

          <!-- Purchase Form -->
          <div class="mt-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Complete Your Purchase</h2>
            <form method="POST" class="space-y-4">
              {% csrf_token %}

              <!-- Quantity Field -->
              <div class="space-y-2">
                <label for="id_quantity" class="block text-sm font-medium text-gray-700">
                  Quantity
                </label>
                <input type="number" name="quantity" id="id_quantity" min="1" max="{{ plant.quantity_available }}" value="1" step="1"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                {% if form.quantity.errors %}
                <div class="text-red-500 text-sm">
                  {% for error in form.quantity.errors %}
                  <p>{{ error }}</p>
                  {% endfor %}
                </div>
                {% endif %}
              </div>

              <!-- Shipping Address Field -->
              <div class="space-y-2">
                <label for="id_shipping_address" class="block text-sm font-medium text-gray-700">
                  Shipping Address
                </label>
                <textarea name="shipping_address" id="id_shipping_address" rows="3" placeholder="Enter your full shipping address"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">{{ form.shipping_address.value|default:'' }}</textarea>
                {% if form.shipping_address.errors %}
                <div class="text-red-500 text-sm">
                  {% for error in form.shipping_address.errors %}
                  <p>{{ error }}</p>
                  {% endfor %}
                </div>
                {% endif %}
              </div>

              <!-- Contact Phone Field -->
              <div class="space-y-2">
                <label for="id_contact_phone" class="block text-sm font-medium text-gray-700">
                  Contact Phone
                </label>
                <input type="text" name="contact_phone" id="id_contact_phone" placeholder="Enter your contact number"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                       value="{{ form.contact_phone.value|default:'' }}">
                {% if form.contact_phone.errors %}
                <div class="text-red-500 text-sm">
                  {% for error in form.contact_phone.errors %}
                  <p>{{ error }}</p>
                  {% endfor %}
                </div>
                {% endif %}
              </div>

              <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <div class="flex justify-between items-center">
                  <span class="text-gray-700 font-medium">Unit Price:</span>
                  <span class="text-gray-700">₹{{ plant.price }}</span>
                </div>
                <div class="flex justify-between items-center mt-2">
                  <span class="text-gray-700 font-medium">Quantity:</span>
                  <span class="text-gray-700" id="quantity-display">1</span>
                </div>
                <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-200">
                  <span class="text-gray-800 font-bold">Total Price:</span>
                  <span class="text-gray-800 font-bold" id="total-price">₹{{ plant.price }}</span>
                </div>
              </div>

              <div class="pt-4">
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 px-4 rounded-lg transition duration-300 font-medium">
                  Confirm Purchase
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  textarea, input[type="text"] {
    @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500;
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const quantityInput = document.getElementById('id_quantity');
    const quantityDisplay = document.getElementById('quantity-display');
    const totalPriceDisplay = document.getElementById('total-price');
    const unitPrice = {{ plant.price }};
    const maxQuantity = {{ plant.quantity_available }};

    // Simple function to update the total price
    function updateTotalPrice() {
      // Get the current quantity value
      let quantity = parseInt(quantityInput.value) || 1;

      // Update the quantity display
      quantityDisplay.textContent = quantity;

      // Calculate and update the total price
      const totalPrice = (unitPrice * quantity).toFixed(2);
      totalPriceDisplay.textContent = '₹' + totalPrice;

      console.log('Quantity updated:', quantity);
    }

    // Add event listeners for input changes
    quantityInput.addEventListener('input', updateTotalPrice);
    quantityInput.addEventListener('change', updateTotalPrice);
    quantityInput.addEventListener('keyup', updateTotalPrice);

    // Initialize with default values
    updateTotalPrice();

    // Log initial state for debugging
    console.log('Initial state:', {
      quantityInputValue: quantityInput.value,
      quantityInputType: quantityInput.type,
      maxQuantity: maxQuantity
    });
  });
</script>
{% endblock %}
